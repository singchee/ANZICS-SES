
mod_IRSEAD = glmer(DIED_HOSP ~ ANZROD + 
	relevel(IRSEAD, ref= 10) + 
	relevel(Remoteness, ref= 1) + 
	HospitalClassification + 
	year +
	(1|SiteID), 
	data=df3_ANZROD, family=binomial, control = glmerControl(optimizer = "bobyqa"), nAGQ = 0) #IRSEAD

eff_IRSEAD = mod_IRSEAD %>%
    tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
    filter(str_detect(term, "IRSEAD")) %>% #filter out predictors that have "series" 
    mutate(across(c(estimate, starts_with("conf")), exp)) %>%
    mutate(IRSEAD = as.factor(seq_along(1:nrow(.))))
    
library(ggplot2)
library(dplyr)

theme_set(theme_bw(base_size = 14))

eff_IRSAD %>%
  ggplot(aes(x = factor(IRSAD), y = estimate)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey40", linewidth = 0.8) +
  geom_point(size = 3, color = "#1b9e77") +
  geom_linerange(aes(ymin = conf.low, ymax = conf.high),
                 color = "#1b9e77", linewidth = 1) +
  scale_y_continuous(
    limits = c(0.7, 1.3),
    breaks = seq(0.7, 1.3, 0.1)
  ) +
  labs(
    x = "IRSAD Decile (Socioeconomic Advantage)",
    y = "Odds Ratio for Hospital Mortality",
    title = "Association Between Socioeconomic Status and ICU Mortality",
    subtitle = "Adjusted for ANZROD, Remoteness, Hospital Type, and Year"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "grey30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 13, face = "bold"),
    panel.grid.major.y = element_line(color = "grey90", linetype = "dotted"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey50"),
    plot.background = element_rect(fill = "white", color = NA)
  )


    


#Mixed effects modelling for IRSED


mod_IRSED = glmer(DIED_HOSP ~ ANZROD + 
	relevel(IRSED, ref= 10) + 
	relevel(Remoteness, ref= 1) + 
	HospitalClassification + 
	(1|SiteID), 
	data=df3_ANZROD, family=binomial, control = glmerControl(optimizer = "bobyqa"), nAGQ = 0) #IRSED

#check for collinearity
cars::vif(mod_IRSEAD)

#extract IRSED estimates , PLOT SEIFA Estimates
 eff_IRSED = mod_IRSED %>%
     tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
     filter(str_detect(term, "IRSED")) %>% #filter out predictors that have "series" 
     mutate(across(c(estimate, starts_with("conf")), exp)) %>%
     mutate(IRSED = as.factor(seq_along(1:nrow(.))))


  eff_IRSED %>%
    ggplot(aes(x=IRSED, estimate)) + #plot
     geom_point() + 
    geom_linerange(aes(ymin = conf.low, ymax = conf.high))


eff_remoteness = mod %>%
    tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
    filter(str_detect(term, "Remote")) %>% #filter out predictors that have "series" 
    mutate(across(c(estimate, starts_with("conf")), exp)) %>%
    mutate(Remoteness = as.factor(seq_along(1:nrow(.))+1))

eff_remoteness %>%
    ggplot(aes(x=Remoteness, estimate)) + #plot
    geom_point() + 
    geom_linerange(aes(ymin = conf.low, ymax = conf.high))

car::Anova(mod)
